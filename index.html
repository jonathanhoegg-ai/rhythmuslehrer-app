<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythmuslehrer - Live Multiplayer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .role-selection {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .role-btn {
            padding: 20px 40px;
            font-size: 1.5em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .role-btn.teacher {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .role-btn.student {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .role-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .teacher-view, .student-view {
            display: none;
        }
        
        .game-code-display {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin: 20px 0;
        }
        
        .game-code {
            font-size: 4em;
            font-weight: bold;
            color: #333;
            letter-spacing: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        #qrcode {
            margin: 20px auto;
            display: flex;
            justify-content: center;
        }
        
        .student-join {
            text-align: center;
            padding: 30px;
        }
        
        .code-input {
            font-size: 2em;
            padding: 15px 30px;
            border: 3px solid #667eea;
            border-radius: 15px;
            text-align: center;
            letter-spacing: 5px;
            text-transform: uppercase;
            margin: 20px 0;
            width: 100%;
            max-width: 400px;
        }
        
        .name-input {
            font-size: 1.5em;
            padding: 15px 30px;
            border: 3px solid #667eea;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            width: 100%;
            max-width: 400px;
        }
        
        .btn {
            padding: 15px 40px;
            font-size: 1.3em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .settings label {
            display: block;
            margin: 15px 0;
            font-size: 1.2em;
            color: #333;
        }
        
        select {
            padding: 10px;
            font-size: 1.1em;
            border: 2px solid #667eea;
            border-radius: 10px;
            margin-left: 10px;
        }
        
        .notation {
            background: white;
            padding: 40px;
            margin: 30px 0;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            font-size: 3em;
            font-family: 'Segoe UI Symbol', 'Apple Color Emoji', 'Noto Music', serif;
            line-height: 1;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .answer-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        
        .answer-card {
            padding: 30px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid transparent;
        }
        
        .answer-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .answer-card.selected {
            border: 4px solid #fff;
            box-shadow: 0 0 20px rgba(255,255,255,0.8);
        }
        
        .answer-red { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .answer-blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .answer-orange { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .answer-green { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        
        .play-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
        }
        
        .play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        
        .players-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .player-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .score {
            font-weight: bold;
            font-size: 1.3em;
            color: #667eea;
        }
        
        .results-view {
            display: none;
        }
        
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .result-card h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        
        .result-table {
            width: 100%;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .result-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .result-table td {
            padding: 15px;
            color: #333;
            border-bottom: 1px solid #eee;
        }
        
        .result-table tr:hover {
            background: #f8f9fa;
        }
        
        .waiting-screen {
            text-align: center;
            padding: 50px;
        }
        
        .waiting-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin: 20px 0;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .feedback {
            font-size: 2em;
            text-align: center;
            padding: 30px;
            margin: 20px 0;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .feedback.correct {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .feedback.wrong {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .game-code {
                font-size: 2.5em;
                letter-spacing: 5px;
            }
            
            .answer-grid {
                grid-template-columns: 1fr;
            }
            
            .notation {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Rhythmuslehrer Live üéµ</h1>
        
        <!-- Role Selection -->
        <div class="role-selection" id="roleSelection">
            <button class="role-btn teacher" onclick="selectRole('teacher')">
                üë®‚Äçüè´ Lehrer
            </button>
            <button class="role-btn student" onclick="selectRole('student')">
                üë®‚Äçüéì Sch√ºler
            </button>
        </div>
        
        <!-- Teacher View -->
        <div class="teacher-view" id="teacherView">
            <div class="settings">
                <h2>‚öôÔ∏è Spieleinstellungen</h2>
                <label>
                    Schwierigkeit:
                    <select id="difficulty">
                        <option value="beginner">Anf√§nger</option>
                        <option value="intermediate">Fortgeschritten</option>
                        <option value="advanced">Profi</option>
                    </select>
                </label>
                <label>
                    <input type="checkbox" id="includePauses"> Pausen einbeziehen
                </label>
                <label>
                    Instrument:
                    <select id="instrument">
                        <option value="sine">Klavier</option>
                        <option value="square">Synthesizer</option>
                        <option value="drum">Schlagzeug</option>
                        <option value="bass">Bass</option>
                        <option value="clap">Clap</option>
                        <option value="hihat">HiHat</option>
                    </select>
                </label>
            </div>
            
            <div class="game-code-display" id="gameCodeDisplay" style="display: none;">
                <h2>Spielcode:</h2>
                <div class="game-code" id="gameCodeText"></div>
                <div id="qrcode"></div>
                <p>Sch√ºler k√∂nnen per QR-Code oder Code beitreten!</p>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-primary" id="createGameBtn" onclick="createGame()">
                    üéÆ Neues Spiel erstellen
                </button>
                <button class="btn btn-success" id="startGameBtn" onclick="startGame()" style="display: none;">
                    ‚ñ∂Ô∏è Spiel starten
                </button>
                <button class="btn btn-danger" id="endGameBtn" onclick="endGame()" style="display: none;">
                    ‚èπÔ∏è Spiel beenden
                </button>
            </div>
            
            <div class="players-list" id="playersList" style="display: none;">
                <h2>üë• Teilnehmer (<span id="playerCount">0</span>)</h2>
                <div id="playersContainer"></div>
            </div>
            
            <div id="questionDisplay" style="display: none;">
                <h2 style="text-align: center; color: #667eea; margin: 30px 0;">
                    Frage <span id="questionNumber">1</span> von <span id="totalQuestions">10</span>
                </h2>
                
                <div class="notation" id="mainNotation"></div>
                
                <div class="answer-grid">
                    <div class="answer-card answer-red" id="teacherOption0">
                        <button class="play-btn" onclick="playTeacherSound(0)">‚ñ∂Ô∏è</button>
                    </div>
                    <div class="answer-card answer-blue" id="teacherOption1">
                        <button class="play-btn" onclick="playTeacherSound(1)">‚ñ∂Ô∏è</button>
                    </div>
                    <div class="answer-card answer-orange" id="teacherOption2">
                        <button class="play-btn" onclick="playTeacherSound(2)">‚ñ∂Ô∏è</button>
                    </div>
                    <div class="answer-card answer-green" id="teacherOption3">
                        <button class="play-btn" onclick="playTeacherSound(3)">‚ñ∂Ô∏è</button>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="nextQuestion()">
                        ‚û°Ô∏è N√§chste Frage
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Student View -->
        <div class="student-view" id="studentView">
            <div class="student-join" id="studentJoin">
                <h2>Tritt einem Spiel bei!</h2>
                <input type="text" class="name-input" id="studentName" placeholder="Dein Name" maxlength="20">
                <input type="text" class="code-input" id="joinCode" placeholder="SPIELCODE" maxlength="6">
                <button class="btn btn-primary" onclick="joinGame()">Beitreten</button>
            </div>
            
            <div class="waiting-screen" id="waitingScreen" style="display: none;">
                <div class="spinner"></div>
                <h2>Warte auf den Spielstart...</h2>
                <p>Spielcode: <strong id="currentGameCode"></strong></p>
                <p>Name: <strong id="currentPlayerName"></strong></p>
            </div>
            
            <div id="studentQuestion" style="display: none;">
                <h2 style="text-align: center; color: #667eea; margin: 30px 0;">
                    Frage <span id="studentQuestionNumber">1</span>
                </h2>
                
                <div class="notation" id="studentNotation"></div>
                
                <div class="answer-grid">
                    <div class="answer-card answer-red" onclick="selectAnswer(0)">
                        <button class="play-btn" onclick="event.stopPropagation(); playSound(0)">‚ñ∂Ô∏è</button>
                    </div>
                    <div class="answer-card answer-blue" onclick="selectAnswer(1)">
                        <button class="play-btn" onclick="event.stopPropagation(); playSound(1)">‚ñ∂Ô∏è</button>
                    </div>
                    <div class="answer-card answer-orange" onclick="selectAnswer(2)">
                        <button class="play-btn" onclick="event.stopPropagation(); playSound(2)">‚ñ∂Ô∏è</button>
                    </div>
                    <div class="answer-card answer-green" onclick="selectAnswer(3)">
                        <button class="play-btn" onclick="event.stopPropagation(); playSound(3)">‚ñ∂Ô∏è</button>
                    </div>
                </div>
                
                <div id="studentFeedback"></div>
            </div>
        </div>
        
        <!-- Results View -->
        <div class="results-view" id="resultsView">
            <div class="result-card">
                <h2>üèÜ Spielergebnisse üèÜ</h2>
                <table class="result-table">
                    <thead>
                        <tr>
                            <th>Platz</th>
                            <th>Name</th>
                            <th>Punkte</th>
                            <th>Richtig</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody"></tbody>
                </table>
                <button class="btn btn-primary" onclick="location.reload()">
                    üîÑ Neues Spiel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAaes6rfnB-MaNnQl94Vy4RZoWQKhQoI-U",
            authDomain: "rhythmuslehrer-werkstattschule.firebaseapp.com",
            databaseURL: "https://rhythmuslehrer-werkstattschule-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "rhythmuslehrer-werkstattschule",
            storageBucket: "rhythmuslehrer-werkstattschule.firebasestorage.app",
            messagingSenderId: "55494178199",
            appId: "1:55494178199:web:da34e02ff8a90bbdcdc0d2"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Game State
        let currentRole = null;
        let currentGameCode = null;
        let currentPlayerId = null;
        let currentQuestionIndex = 0;
        let totalQuestions = 10;
        let gameQuestions = [];
        let playerScore = 0;
        let audioContext;
        
        // Rhythm Database
        const rhythms = {
            beginner: {
                withoutPauses: [
                    { notation: '| 4/4  ‚ô© ‚ô© ‚ô© ‚ô© |', pattern: [1, 1, 1, 1], description: 'Vier Viertelnoten' },
                    { notation: '| 4/4  ‚ô™‚ô™ ‚ô™‚ô™ ‚ô© ‚ô© |', pattern: [0.5, 0.5, 0.5, 0.5, 1, 1], description: 'Zwei Achtel, dann zwei Viertel' },
                    { notation: '| 4/4  ‚ô© ‚ô™‚ô™ ‚ô© ‚ô© |', pattern: [1, 0.5, 0.5, 1, 1], description: 'Viertel, zwei Achtel, zwei Viertel' },
                    { notation: '| 4/4  ùÖóùÖ• ùÖóùÖ• |', pattern: [2, 2], description: 'Zwei Halbe' },
                    { notation: '| 4/4  ‚ô™‚ô™ ‚ô© ‚ô™‚ô™ ‚ô© |', pattern: [0.5, 0.5, 1, 0.5, 0.5, 1], description: 'Achtel-Viertel-Achtel-Viertel' }
                ],
                withPauses: [
                    { notation: '| 4/4  ‚ô© ùÑΩ ‚ô© ‚ô© |', pattern: [1, 0, 1, 1], description: 'Viertel-Pause-Viertel-Viertel' },
                    { notation: '| 4/4  ‚ô© ‚ô© ùÑΩ ‚ô© |', pattern: [1, 1, 0, 1], description: 'Zwei Viertel-Pause-Viertel' },
                    { notation: '| 4/4  ùÑΩ ‚ô© ‚ô© ‚ô© |', pattern: [0, 1, 1, 1], description: 'Pause-drei Viertel' }
                ]
            },
            intermediate: {
                withoutPauses: [
                    { notation: '| 4/4  ‚ô©. ‚ô™ ‚ô© ‚ô© |', pattern: [1.5, 0.5, 1, 1], description: 'Punktierte Viertel, Achtel, zwei Viertel' },
                    { notation: '| 4/4  ‚ô™‚ô™ ‚ô™‚ô™ ‚ô™‚ô™ ‚ô™‚ô™ |', pattern: [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], description: 'Acht Achtelnoten' },
                    { notation: '| 4/4  ‚ô© ‚ô©. ‚ô™ ‚ô© |', pattern: [1, 1.5, 0.5, 1], description: 'Viertel, punktierte Viertel, Achtel, Viertel' },
                    { notation: '| 4/4  ‚ô™‚ô™ ‚ô©. ‚ô™ ‚ô© |', pattern: [0.5, 0.5, 1.5, 0.5, 1], description: 'Zwei Achtel, punktierte Viertel, Achtel, Viertel' }
                ],
                withPauses: [
                    { notation: '| 4/4  ‚ô©. ùÑΩ ‚ô™‚ô™ ‚ô© |', pattern: [1.5, 0, 0.5, 0.5, 1], description: 'Punktierte Viertel-Pause-zwei Achtel-Viertel' },
                    { notation: '| 4/4  ‚ô© ‚ô™ ùÑΩ ‚ô™ ‚ô© |', pattern: [1, 0.5, 0, 0.5, 1], description: 'Viertel-Achtel-Pause-Achtel-Viertel' }
                ]
            },
            advanced: {
                withoutPauses: [
                    { notation: '| 4/4  ‚ô¨‚ô¨ ‚ô™‚ô™ ‚ô©. ‚ô™ |', pattern: [0.25, 0.25, 0.25, 0.25, 0.5, 0.5, 1.5, 0.5], description: 'Sechzehntel, Achtel, punktierte Viertel, Achtel' },
                    { notation: '| 4/4  ‚ô© ‚ô¨‚ô¨ ‚ô™ ‚ô©. ‚ô™ |', pattern: [1, 0.25, 0.25, 0.25, 0.25, 0.5, 1.5, 0.5], description: 'Viertel, Sechzehntel, Achtel, punktierte Viertel, Achtel' },
                    { notation: '| 4/4  ‚ô™ ‚ô¨‚ô¨ ‚ô™ ‚ô¨‚ô¨ ‚ô© |', pattern: [0.5, 0.25, 0.25, 0.25, 0.25, 0.5, 0.25, 0.25, 0.25, 0.25, 1], description: 'Achtel-Sechzehntel Mix' }
                ],
                withPauses: [
                    { notation: '| 4/4  ‚ô© ùÑΩ ‚ô¨‚ô¨ ‚ô©. ‚ô™ |', pattern: [1, 0, 0.25, 0.25, 0.25, 0.25, 1.5, 0.5], description: 'Viertel-Pause-Sechzehntel-punktierte Viertel-Achtel' }
                ]
            }
        };
        
        // Feedback messages
        const correctMessages = [
            'üéâ Perfekt!', 'üî• Mega gut!', '‚≠ê Spitze!', 'üí™ Richtig stark!',
            'üéµ Musikgenie!', 'üëè Bravo!', 'üåü Fantastisch!', 'üéä Super!',
            'üöÄ Hammer!', 'üíØ Genau richtig!'
        ];
        
        const wrongMessages = [
            'ü§î Fast! Versuch\'s nochmal!', 'üí≠ Knapp daneben!', 'üéØ Beim n√§chsten Mal!',
            'üé™ Nicht ganz, aber gut probiert!', 'üåà Weiter so!', 'üé® Fast richtig!',
            'üé≠ Nah dran!', 'üé™ √úben macht den Meister!', 'üé¨ N√§chstes Mal!', 'üé∏ Bleib dran!'
        ];
        
        // Audio Context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        // Generate random game code
        function generateGameCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // Role Selection
        function selectRole(role) {
            currentRole = role;
            document.getElementById('roleSelection').style.display = 'none';
            
            if (role === 'teacher') {
                document.getElementById('teacherView').style.display = 'block';
            } else {
                document.getElementById('studentView').style.display = 'block';
            }
        }
        
        // Teacher: Create Game
        async function createGame() {
            initAudio();
            currentGameCode = generateGameCode();
            
            const difficulty = document.getElementById('difficulty').value;
            const includePauses = document.getElementById('includePauses').checked;
            const instrument = document.getElementById('instrument').value;
            
            // Generate questions
            gameQuestions = generateQuestions(difficulty, includePauses, 10);
            
            // Save game to Firebase
            await database.ref('games/' + currentGameCode).set({
                code: currentGameCode,
                difficulty: difficulty,
                includePauses: includePauses,
                instrument: instrument,
                questions: gameQuestions,
                status: 'waiting',
                createdAt: Date.now(),
                currentQuestion: 0
            });
            
            // Show game code and QR
            document.getElementById('gameCodeDisplay').style.display = 'block';
            document.getElementById('gameCodeText').textContent = currentGameCode;
            document.getElementById('createGameBtn').style.display = 'none';
            document.getElementById('startGameBtn').style.display = 'inline-block';
            document.getElementById('endGameBtn').style.display = 'inline-block';
            document.getElementById('playersList').style.display = 'block';
            
            // Generate QR Code
            const joinUrl = window.location.href.split('?')[0] + '?game=' + currentGameCode;
            document.getElementById('qrcode').innerHTML = '';
            QRCode.toCanvas(document.createElement('canvas'), joinUrl, {
                width: 200,
                margin: 2
            }, function(error, canvas) {
                if (!error) {
                    document.getElementById('qrcode').appendChild(canvas);
                }
            });
            
            // Listen for players
            database.ref('games/' + currentGameCode + '/players').on('value', (snapshot) => {
                updatePlayersList(snapshot.val());
            });
        }
        
        // Generate questions for game
        function generateQuestions(difficulty, includePauses, count) {
            const pool = includePauses 
                ? [...rhythms[difficulty].withoutPauses, ...rhythms[difficulty].withPauses]
                : rhythms[difficulty].withoutPauses;
            
            const questions = [];
            for (let i = 0; i < count; i++) {
                const correct = pool[Math.floor(Math.random() * pool.length)];
                const options = [correct];
                
                while (options.length < 4) {
                    const option = pool[Math.floor(Math.random() * pool.length)];
                    if (!options.find(o => o.notation === option.notation)) {
                        options.push(option);
                    }
                }
                
                // Shuffle options
                options.sort(() => Math.random() - 0.5);
                const correctIndex = options.findIndex(o => o.notation === correct.notation);
                
                questions.push({
                    notation: correct.notation,
                    options: options,
                    correctIndex: correctIndex
                });
            }
            
            return questions;
        }
        
        // Update players list
        function updatePlayersList(players) {
            const container = document.getElementById('playersContainer');
            const count = document.getElementById('playerCount');
            
            if (!players) {
                container.innerHTML = '<p>Noch keine Teilnehmer...</p>';
                count.textContent = '0';
                return;
            }
            
            const playerArray = Object.values(players);
            count.textContent = playerArray.length;
            
            container.innerHTML = playerArray.map(player => `
                <div class="player-item">
                    <span>üë§ ${player.name}</span>
                    <span class="score">${player.score || 0} Punkte</span>
                </div>
            `).join('');
        }
        
        // Teacher: Start Game
        async function startGame() {
            await database.ref('games/' + currentGameCode).update({
                status: 'playing',
                currentQuestion: 0
            });
            
            document.getElementById('startGameBtn').style.display = 'none';
            document.getElementById('questionDisplay').style.display = 'block';
            document.getElementById('gameCodeDisplay').style.display = 'none';
            
            displayTeacherQuestion(0);
        }
        
        // Display question for teacher
        function displayTeacherQuestion(index) {
            if (index >= gameQuestions.length) {
                endGame();
                return;
            }
            
            currentQuestionIndex = index;
            const question = gameQuestions[index];
            
            document.getElementById('questionNumber').textContent = index + 1;
            document.getElementById('totalQuestions').textContent = gameQuestions.length;
            document.getElementById('mainNotation').textContent = question.notation;
            
            // Display options
            for (let i = 0; i < 4; i++) {
                const card = document.getElementById('teacherOption' + i);
                card.innerHTML = `
                    <button class="play-btn" onclick="playTeacherSound(${i})">‚ñ∂Ô∏è</button>
                `;
            }
        }
        
        // Play sound for teacher
        function playTeacherSound(optionIndex) {
            const question = gameQuestions[currentQuestionIndex];
            const rhythm = question.options[optionIndex];
            playRhythm(rhythm.pattern);
        }
        
        // Next question
        async function nextQuestion() {
            const nextIndex = currentQuestionIndex + 1;
            
            await database.ref('games/' + currentGameCode).update({
                currentQuestion: nextIndex
            });
            
            displayTeacherQuestion(nextIndex);
        }
        
        // End game
        async function endGame() {
            await database.ref('games/' + currentGameCode).update({
                status: 'finished'
            });
            
            // Get final results
            const snapshot = await database.ref('games/' + currentGameCode + '/players').once('value');
            const players = snapshot.val();
            
            showResults(players);
        }
        
        // Show results
        function showResults(players) {
            document.getElementById('teacherView').style.display = 'none';
            document.getElementById('resultsView').style.display = 'block';
            
            if (!players) return;
            
            const playerArray = Object.entries(players).map(([id, data]) => ({
                id,
                name: data.name,
                score: data.score || 0,
                correct: data.correctAnswers || 0
            }));
            
            playerArray.sort((a, b) => b.score - a.score);
            
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = playerArray.map((player, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${player.name}</td>
                    <td>${player.score}</td>
                    <td>${player.correct}</td>
                </tr>
            `).join('');
        }
        
        // Student: Join Game
        async function joinGame() {
            initAudio();
            const name = document.getElementById('studentName').value.trim();
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            
            if (!name || !code) {
                alert('Bitte Namen und Spielcode eingeben!');
                return;
            }
            
            // Check if game exists
            const gameSnapshot = await database.ref('games/' + code).once('value');
            if (!gameSnapshot.exists()) {
                alert('Spiel nicht gefunden! Bitte Code √ºberpr√ºfen.');
                return;
            }
            
            currentGameCode = code;
            currentPlayerId = 'player_' + Date.now();
            
            // Add player to game
            await database.ref('games/' + code + '/players/' + currentPlayerId).set({
                name: name,
                score: 0,
                correctAnswers: 0,
                joinedAt: Date.now()
            });
            
            // Show waiting screen
            document.getElementById('studentJoin').style.display = 'none';
            document.getElementById('waitingScreen').style.display = 'block';
            document.getElementById('currentGameCode').textContent = code;
            document.getElementById('currentPlayerName').textContent = name;
            
            // Listen for game status
            database.ref('games/' + code).on('value', (snapshot) => {
                const game = snapshot.val();
                if (game.status === 'playing') {
                    displayStudentQuestion(game.currentQuestion);
                } else if (game.status === 'finished') {
                    showStudentResults();
                }
            });
        }
        
        // Display question for student
        async function displayStudentQuestion(questionIndex) {
            const gameSnapshot = await database.ref('games/' + currentGameCode).once('value');
            const game = gameSnapshot.val();
            const question = game.questions[questionIndex];
            
            if (!question) return;
            
            document.getElementById('waitingScreen').style.display = 'none';
            document.getElementById('studentQuestion').style.display = 'block';
            document.getElementById('studentQuestionNumber').textContent = questionIndex + 1;
            document.getElementById('studentNotation').textContent = question.notation;
            document.getElementById('studentFeedback').innerHTML = '';
            
            // Reset answer selection
            const cards = document.querySelectorAll('#studentQuestion .answer-card');
            cards.forEach(card => card.classList.remove('selected'));
            
            currentQuestionIndex = questionIndex;
        }
        
        // Student: Select Answer
        async function selectAnswer(optionIndex) {
            const gameSnapshot = await database.ref('games/' + currentGameCode).once('value');
            const game = gameSnapshot.val();
            const question = game.questions[currentQuestionIndex];
            
            const isCorrect = optionIndex === question.correctIndex;
            
            // Visual feedback
            const cards = document.querySelectorAll('#studentQuestion .answer-card');
            cards.forEach(card => card.classList.remove('selected'));
            cards[optionIndex].classList.add('selected');
            
            // Show feedback
            const feedback = document.getElementById('studentFeedback');
            if (isCorrect) {
                feedback.className = 'feedback correct';
                feedback.textContent = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                
                // Update score
                const playerRef = database.ref('games/' + currentGameCode + '/players/' + currentPlayerId);
                const playerSnapshot = await playerRef.once('value');
                const playerData = playerSnapshot.val();
                
                await playerRef.update({
                    score: (playerData.score || 0) + 10,
                    correctAnswers: (playerData.correctAnswers || 0) + 1
                });
            } else {
                feedback.className = 'feedback wrong';
                feedback.textContent = wrongMessages[Math.floor(Math.random() * wrongMessages.length)];
            }
            
            // Wait for next question
            setTimeout(() => {
                document.getElementById('studentQuestion').style.display = 'none';
                document.getElementById('waitingScreen').style.display = 'block';
            }, 2000);
        }
        
        // Play sound
        function playSound(optionIndex) {
            const gameRef = database.ref('games/' + currentGameCode);
            gameRef.once('value').then((snapshot) => {
                const game = snapshot.val();
                const question = game.questions[currentQuestionIndex];
                const rhythm = question.options[optionIndex];
                playRhythm(rhythm.pattern);
            });
        }
        
        // Play rhythm pattern
        function playRhythm(pattern) {
            if (!audioContext) initAudio();
            
            const gameRef = database.ref('games/' + currentGameCode);
            gameRef.once('value').then((snapshot) => {
                const game = snapshot.val();
                const instrument = game.instrument || 'sine';
                
                const tempo = 120;
                const beatDuration = 60 / tempo;
                let currentTime = audioContext.currentTime;
                
                pattern.forEach(duration => {
                    if (duration > 0) {
                        playNote(currentTime, duration * beatDuration, instrument);
                    }
                    currentTime += duration * beatDuration;
                });
            });
        }
        
        // Play single note
        function playNote(startTime, duration, instrument) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            switch(instrument) {
                case 'sine':
                    oscillator.type = 'sine';
                    oscillator.frequency.value = 440;
                    break;
                case 'square':
                    oscillator.type = 'square';
                    oscillator.frequency.value = 220;
                    break;
                case 'drum':
                    oscillator.type = 'sine';
                    oscillator.frequency.value = 100;
                    gainNode.gain.setValueAtTime(0.3, startTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.1);
                    break;
                case 'bass':
                    oscillator.type = 'triangle';
                    oscillator.frequency.value = 110;
                    break;
                case 'clap':
                    const bufferSize = audioContext.sampleRate * 0.1;
                    const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = Math.random() * 2 - 1;
                    }
                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    gainNode.gain.value = 0.2;
                    source.start(startTime);
                    return;
                case 'hihat':
                    const hhBufferSize = audioContext.sampleRate * 0.05;
                    const hhBuffer = audioContext.createBuffer(1, hhBufferSize, audioContext.sampleRate);
                    const hhData = hhBuffer.getChannelData(0);
                    for (let i = 0; i < hhBufferSize; i++) {
                        hhData[i] = (Math.random() * 2 - 1) * Math.exp(-i / (hhBufferSize * 0.2));
                    }
                    const hhSource = audioContext.createBufferSource();
                    hhSource.buffer = hhBuffer;
                    hhSource.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    gainNode.gain.value = 0.3;
                    hhSource.start(startTime);
                    return;
            }
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            gainNode.gain.setValueAtTime(0.3, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
            
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        }
        
        // Show results for student
        function showStudentResults() {
            document.getElementById('studentQuestion').style.display = 'none';
            document.getElementById('waitingScreen').style.display = 'none';
            
            database.ref('games/' + currentGameCode + '/players/' + currentPlayerId).once('value')
                .then((snapshot) => {
                    const playerData = snapshot.val();
                    const score = playerData.score || 0;
                    const correct = playerData.correctAnswers || 0;
                    
                    const container = document.getElementById('studentView');
                    container.innerHTML = `
                        <div class="result-card">
                            <h2>Dein Ergebnis</h2>
                            <h1 style="font-size: 5em; margin: 30px 0;">${score} Punkte</h1>
                            <p style="font-size: 1.5em;">
                                ${correct} von ${gameQuestions.length} richtig
                            </p>
                            <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 30px;">
                                üîÑ Nochmal spielen
                            </button>
                        </div>
                    `;
                });
        }
        
        // Check for game code in URL
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameCode = urlParams.get('game');
            if (gameCode) {
                selectRole('student');
                document.getElementById('joinCode').value = gameCode;
            }
        });
    </script>
</body>
</html>